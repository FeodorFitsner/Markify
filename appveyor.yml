version: 1.0.{build}

configuration:
- Release

init:
- appveyor version

on_finish:
  - ps: Invoke-WebRequest "$env:APPVEYOR_API_URL/api/test-counters"
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

before_build:
- cmd: nuget restore src\Markify.sln -verbosity detailed
build:
  project: src/Markify.sln
  verbosity: minimal
environment:
    COVERALLS_REPO_TOKEN:  
       secure: LzNrIl+p3PFuAPMSM+HwdnXT+edzlFsl/owok+qNPpOiVhkOIk1hQN9ZuPnzULzO
test:
  assemblies:
  - src\Services\Roslyn\Markify.Services.Roslyn.Tests\bin\Debug\Markify.Services.Roslyn.Tests.dll
  - src\Core\Markify.Core.FSharp.Tests\bin\Debug\Markify.Core.FSharp.Tests.dll
  - src\Services\Document\Markify.Services.Document.Tests\bin\Debug\Markify.Services.Document.Tests.dll
  - src\Services\VisualStudio\Markify.Services.VisualStudio.Tests\bin\Debug\Markify.Services.VisualStudio.Tests.dll
  - src\Services\Rendering\Markify.Services.Rendering.Tests\bin\Debug\Markify.Services.Rendering.Tests.dll
  - src\Services\Rendering\Markify.Services.Rendering.T4.Tests\bin\Debug\Markify.Services.Rendering.T4.Tests.dll
after_test:
    - ps: >-
        $tests = (
          ("Markify.Services.Roslyn.Tests", "Services\Roslyn"),
          ("Markify.Core.FSharp.Tests", "Core\"),
          ("Markify.Services.Document.Tests", "Services\Document"),
          ("Markify.Services.VisualStudio.Tests", "Services\VisualStudio"),
          ("Markify.Services.Rendering.Tests", "Services\Rendering"),
          ("Markify.Services.Rendering.T4.Tests", "Services\Rendering")
        )

        $filter = "+[Markify*]* -[*.Tests]*"

        $xunitConsole = (Resolve-Path "src/packages/xunit.runner.console.2.*/tools/xunit.console.exe").ToString()

        foreach($test in $tests) {
          & $xunitConsole ".\src\$($test[1])\$($test[0])\bin\$env:CONFIGURATION\$($test[0]).dll" -noshadow
        }
